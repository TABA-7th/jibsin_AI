import time
import pandas as pd
import cv2
import json
from PIL import Image
import requests
import uuid
import time
import openai
import re
import base64
import numpy as np
import os
from io import BytesIO
from dotenv import load_dotenv
from firebase_api.utils import save_ocr_result_to_firestore


# í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ
load_dotenv()

# API ì„¤ì •
secret_key = os.getenv("OCR_SECRET_KEY")
api_url = os.getenv("OCR_API_URL")
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
MODEL = "gpt-4o" 

client = openai.OpenAI(api_key=OPENAI_API_KEY)

def base_xy(i):
    if i==1:
        rows = [
            ['ì£¼íƒì„ëŒ€ì°¨í‘œì¤€ê³„ì•½ì„œ',396,119,838,173],
            ['ì„ëŒ€ì¸', 127, 193, 198, 221],
            ['(ì„ëŒ€ì¸)', 198, 193, 410, 221],
            ['ì„ì°¨ì¸', 445, 193, 510, 221],
            ['(ì„ì°¨ì¸)', 510, 193, 725, 221],
            ['ì†Œì¬ì§€', 94, 291, 186, 319],
            ['(ì†Œì¬ì§€)', 333, 289, 1203, 321],
            ['[ì„ì°¨ì£¼íƒì˜ í‘œì‹œ]',70,244,302,282],
            ['í† ì§€',101,321,182,357],
            ['(í† ì§€)', 330,322,681,356],
            ['ê±´ë¬¼',103,357,183,388],
            ['(ê±´ë¬¼)',103,357,183,388],
            ['ë©´ì ',712,322,764,355],
            ['(ë©´ì )',803,322,1179,358],
            ['ê³„ì•½ê¸°ê°„',240,521,330,546],
            ['(ê³„ì•½ê¸°ê°„)',336,518,620,548],
            ['ë³´ì¦ê¸ˆ_1',633,523,697,547],
            ['(ë³´ì¦ê¸ˆ_1)',691,520,861,548],
            ['ì°¨ì„_1', 878,521,927,547],
            ['(ì°¨ì„_1)',925,516,1113,549],
            ['ê³„ì•½ë‚´ìš©',74,734,206,769],
            ['ë³´ì¦ê¸ˆ_2',93,824,182,865],
            ['(ë³´ì¦ê¸ˆ_2)',220,826,966,863],
            ['ê³„ì•½ê¸ˆ',95,866,178,906],
            ['(ê³„ì•½ê¸ˆ)',220,865,646,904],
            ['ì¤‘ë„ê¸ˆ',93,908,177,946],
            ['(ì¤‘ë„ê¸ˆ)', 217,907,1004,946],
            ['ì”ê¸ˆ',92,947,177,984],
            ['(ì”ê¸ˆ)',218,945,1012,984],
            ['ì°¨ì„(ì›”ì„¸)',86,987,182,1028],
            ['(ì°¨ì„_2)',220,989,607,1023],
            ['ì…ê¸ˆê³„ì¢Œ',722,990,809,1022],
            ['(ì…ê¸ˆê³„ì¢Œ)', 806,995,1140,1021],
            ['(ì •ì•¡)',360,1026,1028,1069],
            ['(ë¹„ì •ì•¡)',408,1258,1197,1290],
            ['(ì„ëŒ€ì¼)',877,1344,1145,1378],
            ['(ì„ëŒ€ì°¨ê¸°ê°„)',554,1370,922,1401],
            ['ìˆ˜ë¦¬í•„ìš”ì‹œì„¤',90,1479,254,1512],
            ['(ìˆ˜ë¦¬í• ë‚´ìš©)',460,1473,1127,1512],
            ['(ìˆ˜ë¦¬ì™„ë£Œì‹œê¸°)',504,1514,841,1551],
        ]
    elif i==2:
        rows = [
        ['ì„ëŒ€ì¸ë¶€ë‹´',73,215,225,263],
        ['ì„ì°¨ì¸ë¶€ë‹´',75,269,226,310],
        ['(ì„ëŒ€ì¸ë¶€ë‹´)',228,214,1202,264],
        ['(ì„ì°¨ì¸ë¶€ë‹´)',228,264,1200,312],
        ['(ì¤‘ê°œë³´ìˆ˜)', 378,1044,814,1080],
        ['(êµë¶€ì¼)', 378,1156,766,1192],
        ['íŠ¹ì•½ì‚¬í•­',56,1234,1188,1658],
        ]
    else:
        rows = [
        ['íŠ¹ì•½',46,28,1196,166],
        ['(ê³„ì•½ì¼)',510,236,1184,274],
        ['ì„ëŒ€ì¸_ì£¼ì†Œ', 98,288,250,334],
        ['(ì„ëŒ€ì¸_ì£¼ì†Œ)',254,290,1064,338],
        ['ì„ëŒ€ì¸_ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸',110,338,242,386],
        ['(ì„ëŒ€ì¸_ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸)',256,336,564,388],
        ['ì„ëŒ€ì¸_ì „í™”',560,334,692,386],
        ['(ì„ëŒ€ì¸_ì „í™”)',690,338,854,388],
        ['(ì„±ëª…)',930,340,1066,390],
        ['ì„±ëª…', 860,342,926,380],
        ['ì„ëŒ€ì¸_ëŒ€ë¦¬ì¸_ì£¼ì†Œ',258,390,326,434],
        ['ì„ëŒ€ì¸_ëŒ€ë¦¬ì¸_ì£¼ì†Œ', 330,392,562,438],
        ['ì„ëŒ€ì¸_ëŒ€ë¦¬ì¸_ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸',564,388,690,438],
        ['(ì„ëŒ€ì¸_ëŒ€ë¦¬ì¸_ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸)',694,390,858,438],
        ['ì„ëŒ€ì¸_ëŒ€ë¦¬ì¸_ì„±ëª…',862,392,922,434],
        ['(ì„ëŒ€ì¸_ëŒ€ë¦¬ì¸_ì„±ëª…)',932,390,1064,438],
        ['ì„ì°¨ì¸_ì£¼ì†Œ',110,442,246,488],
        ['(ì„ì°¨ì¸_ì£¼ì†Œ)',254,290+154,1064,338+154],
        ['ì„ì°¨ì¸_ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸',110,338+154,242,386+154],
        ['(ì„ì°¨ì¸_ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸)',256,336+154,564,388+154],
        ['ì„ì°¨ì¸_ì „í™”',560,334+154,692,386+154],
        ['(ì„ì°¨ì¸_ì „í™”)',690,338+154,854,388+154],
        ['(ì„ì°¨ì¸_ì„±ëª…)',930,340+154,1066,390+154],
        ['ì„ì°¨ì¸_ì„±ëª…', 860,342+154,926,380+154],
        ['ì„ì°¨ì¸_ëŒ€ë¦¬ì¸_ì£¼ì†Œ',258,390+154,326,434+154],
        ['ì„ì°¨ì¸_ëŒ€ë¦¬ì¸_ì£¼ì†Œ', 330,392+154,562,438+154],
        ['ì„ì°¨ì¸_ëŒ€ë¦¬ì¸_ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸',564,388+154,690,438+154],
        ['(ì„ì°¨ì¸_ëŒ€ë¦¬ì¸_ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸)',694,390+154,858,438+154],
        ['ì„ì°¨ì¸_ëŒ€ë¦¬ì¸_ì„±ëª…',862,392+154,922,434+154],
        ['(ì„ì°¨ì¸_ëŒ€ë¦¬ì¸_ì„±ëª…)',932,390+154,1064,438+154],
        ['ì‚¬ë¬´ì†Œì†Œì¬ì§€_1',110,600,242,642],
        ['(ì‚¬ë¬´ì†Œì†Œì¬ì§€_1)',256,596,562,644],
        ['ì‚¬ë¬´ì†Œëª…ì¹­_1',122,644,236,686],
        ['(ì‚¬ë¬´ì†Œëª…ì¹­_1)',254,642,562,692],
        ['ì‚¬ë¬´ì†Œì†Œì¬ì§€_2',586,594,712,642],
        ['(ì‚¬ë¬´ì†Œì†Œì¬ì§€_2)',740,596,1176,646],
        ['ì‚¬ë¬´ì†Œëª…ì¹­_2',594,642,710,690],
        ['(ì‚¬ë¬´ì†Œëª…ì¹­_2)',740,642,1180,696],
            ]
    xy = pd.DataFrame(columns=['Text', 'x1', 'y1', 'x2', 'y2'])
    xy = pd.concat([xy, pd.DataFrame(rows, columns=xy.columns)], ignore_index=True)
    return xy

def cre_ocr(image, secret_key, api_url):
    """OCR ì¶”ì¶œ í•¨ìˆ˜"""
    target_size = (1240, 1753)
    image_1 = cv2.resize(image, target_size, interpolation=cv2.INTER_AREA)
    
    request_json = {
        'images': [{'format': 'jpg', 'name': 'demo'}],
        'requestId': str(uuid.uuid4()),
        'version': 'V2',
        'timestamp': int(round(time.time() * 1000))
    }
    
    # ì´ë¯¸ì§€ ì²˜ë¦¬
    _, img_encoded = cv2.imencode('.jpg', image_1)
    files = [('file', ('image.jpg', img_encoded.tobytes(), 'image/jpeg'))]
    
    payload = {'message': json.dumps(request_json).encode('UTF-8')}
    headers = {'X-OCR-SECRET': secret_key}
    
    response = requests.request("POST", api_url, headers=headers, data=payload, files=files)
    
    if response.status_code == 200:
        ocr_results = response.json()
        all_data = []
        
        for image_result in ocr_results['images']:
            for field in image_result['fields']:
                text = field['inferText']
                bounding_box = field['boundingPoly']['vertices']
                x1, y1 = int(bounding_box[0]['x']), int(bounding_box[0]['y'])
                x2, y2 = int(bounding_box[2]['x']), int(bounding_box[2]['y'])
                
                all_data.append({
                    "Text": text,
                    "x1": x1, "y1": y1,
                    "x2": x2, "y2": y2
                })
        
        df = pd.DataFrame(all_data) 
        return df
    
    return None

def fix_json_format(text: str) -> str:
    """JSON í˜•ì‹ ì˜¤ë¥˜ ìˆ˜ì • í•¨ìˆ˜"""
    text = text.strip()
    text = text.replace("```json", "").replace("```", "").strip()
    text = re.sub(r'}\s*{', '}, {', text)
    text = re.sub(r'(\d{1,3})(\d{3},\d{3})', r'\1,\2', text)
    return text

def ttj(text: str, output_file: str) -> str:
    """JSON ë°ì´í„° ì •ë¦¬ ë° ì €ì¥ í•¨ìˆ˜"""
    try:
        text = fix_json_format(text)
        data = json.loads(text)
        
        def fix_text(value):
            if value == "NA":
                return value
            value = re.sub(r'(\d+)\s+(\d+)', r'\1,\2', value)
            return value.strip()
        
        for key, value in data.items():
            if isinstance(value, dict) and "text" in value:
                value["text"] = fix_text(value["text"])
        
        with open(output_file, "w", encoding="utf-8") as f:
            json.dump(data, f, ensure_ascii=False, indent=4)
        
        return output_file
    
    except json.JSONDecodeError as e:
        print(f"âŒ JSON ë³€í™˜ ì‹¤íŒ¨: {e}")
        print("ğŸ“Œ ì˜¤ë¥˜ ë°œìƒ JSON ë‚´ìš©:\n", text)
        return f"âŒ JSON ë³€í™˜ ì‹¤íŒ¨: {e}"

def contract_keyword_ocr(image_urls, doc_type, user_id, contract_id):
    """Firebase URLì—ì„œ ê³„ì•½ì„œ OCR ì²˜ë¦¬"""
    all_results = {}
    
    
    for image_url in image_urls:
        try:
            # URLì—ì„œ í˜ì´ì§€ ë²ˆí˜¸ ì¶”ì¶œ ë¶€ë¶„ ìˆ˜ì •
            page_number = int(re.search(r'page(\d+)\.jpg', image_url).group(1))
            
            # URLì—ì„œ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
            response = requests.get(image_url)
            if response.status_code != 200:
                print(f"âŒ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: {image_url}")
                continue
            
            # ì´ë¯¸ì§€ ë°ì´í„° ë³€í™˜
            image_data = response.content
            nparr = np.frombuffer(image_data, np.uint8)
            image = cv2.imdecode(nparr, cv2.IMREAD_COLOR)
            
            # OCR ì²˜ë¦¬
            df = cre_ocr(image, secret_key, api_url)
            if df.empty:
                print(f"âŒ OCR ì²˜ë¦¬ ì‹¤íŒ¨ (í˜ì´ì§€ {page_number})")
                continue
                
            # í˜ì´ì§€ ë²ˆí˜¸ì— ë§ëŠ” base_xy ë§¤í•‘ ê°€ì ¸ì˜¤ê¸°
            xy = base_xy(page_number)
            # JSON ë³€í™˜
            xy_json = xy.to_json(orient="records", force_ascii=False)
            df_json = df.to_json(orient="records", force_ascii=False)
            
        

            # target_texts ì„¤ì • (í˜ì´ì§€ë³„)
            if page_number == 1:
                target_texts = {
                    "ì„ëŒ€ì¸": "ì‚¬ëŒ ì´ë¦„ (ì˜ˆ: í™ê¸¸ë™)",
            "ì„ì°¨ì¸": "ì‚¬ëŒ ì´ë¦„ (ì˜ˆ: ê¹€ì² ìˆ˜)",
            "ì†Œì¬ì§€": "ë„ë¡œëª… ì£¼ì†Œ (ì˜ˆ: ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 123)",
            "í† ì§€":"ì¢…ë¥˜ (ì˜ˆ: ëŒ€)",
            "ê±´ë¬¼":"ì¢…ë¥˜ (ì˜ˆ: ì² ê·¼ì½˜í¬ë¦¬íŠ¸êµ¬ì¡°)",
            "ì„ì°¨í• ë¶€ë¶„":"í˜¸ìˆ˜ (ì˜ˆ: ì œ 1ì¸µ 101í˜¸)",
            "ë©´ì ":"ë©´ì  (ì˜ˆ: 88.8m2)",
            "ê³„ì•½ê¸°ê°„": "YYYY-MM-DD ~ YYYY-MM-DD (ì˜ˆ: 2025-01-01 ~ 2026-01-01)",
            "ë³´ì¦ê¸ˆ_1": "###ì› (ì˜ˆ: 10,000,000ì›)",
            "ë³´ì¦ê¸ˆ_2": "###ì› (ì˜ˆ: 5,000,000ì›)",
            "ê³„ì•½ê¸ˆ": "###ì› (ì˜ˆ: 3,000,000ì›)",
            "ì”ê¸ˆ": "###ì› (YYYY-MM-DDì— ì§€ë¶ˆ) (ì˜ˆ: 7,000,000ì› (2025-06-01ì— ì§€ë¶ˆ))",
            "ì°¨ì„_1": "###ì› (DDì¼) (ì˜ˆ: 500,000ì› (10ì¼))",
            "ì°¨ì„_2": "###ì› (DDì¼) (ì˜ˆ: 600,000ì› (15ì¼))",
            "ì…ê¸ˆê³„ì¢Œ": "ê³„ì¢Œë²ˆí˜¸ í˜•ì‹ (ì˜ˆ: 123-45-67890)",
            "ì¤‘ë„ê¸ˆ": "###ì› (ì˜ˆ: 2,000,000ì›)",
            "ì„ëŒ€ì¼": "YYYY-MM-DD (ì˜ˆ: 2025-02-01)",
            "ì„ëŒ€ì°¨ê¸°ê°„": "YYYY-MM-DD ~ YYYY-MM-DD (ì˜ˆ: 2025-01-01 ~ 2026-01-01)",
            "ìˆ˜ë¦¬í• ë‚´ìš©": "í…ìŠ¤íŠ¸ (ì˜ˆ: ë³´ì¼ëŸ¬ ìˆ˜ë¦¬ í•„ìš”)",
            "ìˆ˜ë¦¬ì™„ë£Œì‹œê¸°": "YYYY-MM-DD (ì˜ˆ: 2025-03-01)"
                }
            elif page_number == 2:
                target_texts = {
                    "ì„ëŒ€ì¸ë¶€ë‹´":"í…ìŠ¤íŠ¸",
                    "ì„ì°¨ì¸ë¶€ë‹´":"í…ìŠ¤íŠ¸",
                    "ì¤‘ê°œë³´ìˆ˜":"ê±°ë˜ê°€ì•¡ì˜ 00%ì¸ ###,###ì›",
                    "êµë¶€ì¼":"YYYY-MM-DD",
                    "íŠ¹ì•½ì‚¬í•­":"í…ìŠ¤íŠ¸"
                }
            else:
                target_texts = {
                    "íŠ¹ì•½": "Text",
        "ê³„ì•½ì¼": "yyyyë…„ mmì›” ddì¼",
        "ì„ëŒ€ì¸_ì£¼ì†Œ": "ë„ë¡œëª… ì£¼ì†Œ (ì˜ˆ: ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 123)",
        "ì„ëŒ€ì¸_ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸": "000000-0000000",
        "ì„ëŒ€ì¸_ì „í™”": "010-0000-0000",
        "ì„±ëª…": "###",
        "ì„ëŒ€ì¸_ëŒ€ë¦¬ì¸_ì£¼ì†Œ": "ë„ë¡œëª… ì£¼ì†Œ (ì˜ˆ: ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 123)",
        "ì„ëŒ€ì¸_ëŒ€ë¦¬ì¸_ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸": "000000-0000000",
        "ì„ëŒ€ì¸_ëŒ€ë¦¬ì¸_ì„±ëª…": "###",        
        "ì„ì°¨ì¸_ì£¼ì†Œ": "ë„ë¡œëª… ì£¼ì†Œ (ì˜ˆ: ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 123)",
        "ì„ì°¨ì¸_ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸": "000000-0000000",
        "ì„ì°¨ì¸_ì „í™”": "010-0000-0000",
        "ì„ì°¨ì¸_ì„±ëª…": "###",
        "ì„ì°¨ì¸_ëŒ€ë¦¬ì¸_ì£¼ì†Œ": "ë„ë¡œëª… ì£¼ì†Œ (ì˜ˆ: ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 123)",
        "ì„ì°¨ì¸_ëŒ€ë¦¬ì¸_ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸": "000000-0000000",
        "ì„ì°¨ì¸_ëŒ€ë¦¬ì¸_ì„±ëª…": "###",
        "ì‚¬ë¬´ì†Œì†Œì¬ì§€_1": "í…ìŠ¤íŠ¸",
        "ì‚¬ë¬´ì†Œì†Œì¬ì§€_2": "ë„ë¡œëª… ì£¼ì†Œ (ì˜ˆ: ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 123)",
        "ì‚¬ë¬´ì†Œëª…ì¹­_1": "í…ìŠ¤íŠ¸",
        "ì‚¬ë¬´ì†Œëª…ì¹­_2": "í…ìŠ¤íŠ¸"
                }

            
            # GPT ë¶„ì„ ìš”ì²­
            response = client.chat.completions.create(
                model=MODEL,
                messages=[
                    {
                        "role": "user",
                        "content": [
                            {
                                "type": "text",
                                "text":  (
                            f"ë‹¤ìŒì€ OCR ë¶„ì„ì„ ìœ„í•œ ë°ì´í„°ì…ë‹ˆë‹¤.\n\n"
                            f"âœ… **ìœ„ì¹˜ ë°ì´í„° (xy):**\n{xy_json}\n\n"
                            f"âœ… **ë‚´ìš© ë°ì´í„° (df):**\n{df_json}\n\n"
                            f"ğŸ’¡ **ì‘ì—… ëª©í‘œ:**\n"
                            f"- `xy` ë°ì´í„°ì˜ ìœ„ì¹˜ ì •ë³´(ì¢Œí‘œ)ë¥¼ í™œìš©í•˜ì—¬ `df` ë°ì´í„°ì™€ ë§¤ì¹­\n"
                            f"- ê° ë°”ìš´ë”© ë°•ìŠ¤ ì•ˆì— í¬í•¨ëœ `df` ë°ì´í„°ë¥¼ ë¶„ì„í•˜ì—¬ ìµœì ì˜ ì¢Œí‘œë¡œ ì¡°ì •\n"
                            f"- ê²¹ì¹˜ëŠ” ë‹¨ì–´ë“¤ì„ ë¬¶ì–´ ìµœì¢… ë°”ìš´ë”© ë°•ìŠ¤ë¥¼ ìƒì„±\n"
                            f"- ë‚´ìš©ì´ ì—†ìœ¼ë©´ 'NA'ë¡œ í‘œì‹œ\n\n"
                            f"ğŸ”¹ **ê° í•­ëª©ì˜ ì¶œë ¥ í˜•ì‹:**\n"
                            + "\n".join([f"- **{key}**: {value}" for key, value in target_texts.items()]) +
                            f"\n\nğŸ¯ **ê²°ê³¼ í˜•ì‹:**\n"
                            f"- JSON í˜•ì‹ìœ¼ë¡œ ë°˜í™˜ (ê° í•­ëª©ì˜ ë°”ìš´ë”© ë°•ìŠ¤ í¬í•¨)\n"
                            f"- **ì¶œë ¥ ë°ì´í„°ê°€ ì§€ì •ëœ í˜•ì‹ê³¼ ë‹¤ë¥¼ ê²½ìš° ìë™ìœ¼ë¡œ ë³€í™˜í•˜ì—¬ ë°˜í™˜**\n\n"
                            f"ğŸ’¡ **ë°˜í™˜ ì˜ˆì‹œ:**\n"
                            f"{{\n"
                            f"  \"ì„ëŒ€ì¸\": {{\"text\": \"í™ê¸¸ë™\", \"bounding_box\": {{\"x1\": 100, \"y1\": 200, \"x2\": 300, \"y2\": 250}}}},\n"
                            f"  \"ì„ì°¨ì¸\": {{\"text\": \"ê¹€ì² ìˆ˜\", \"bounding_box\": {{\"x1\": 120, \"y1\": 220, \"x2\": 320, \"y2\": 270}}}},\n"
                            f"  \"ì†Œì¬ì§€\": {{\"text\": \"ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 123\", \"bounding_box\": {{\"x1\": 140, \"y1\": 240, \"x2\": 340, \"y2\": 290}}}},\n"
                            f"  \"ê³„ì•½ê¸°ê°„\": {{\"text\": \"2025-01-01 ~ 2026-01-01\", \"bounding_box\": {{\"x1\": 150, \"y1\": 250, \"x2\": 350, \"y2\": 300}}}},\n"
                            f"  \"ë³´ì¦ê¸ˆ_1\": {{\"text\": \"10,000,000ì›\", \"bounding_box\": {{\"x1\": 160, \"y1\": 260, \"x2\": 360, \"y2\": 310}}}},\n"
                            f"  \"ì…ê¸ˆê³„ì¢Œ\": {{\"text\": \"123-45-67890\", \"bounding_box\": {{\"x1\": 170, \"y1\": 270, \"x2\": 370, \"y2\": 320}}}}\n"
                            f"}}\n\n"
                            f"âš ï¸ **ì£¼ì˜ì‚¬í•­:**\n"
                            f"- `xy` ë°ì´í„°ì˜ ë°”ìš´ë”© ë°•ìŠ¤ë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ì§€ ë§ê³ , `df` ë°ì´í„°ì™€ ê°€ì¥ ì í•©í•œ ìœ„ì¹˜ë¡œ ì¡°ì •\n"
                            f"- í…ìŠ¤íŠ¸ê°€ ì—¬ëŸ¬ ë°”ìš´ë”© ë°•ìŠ¤ì— ê±¸ì³ ìˆëŠ” ê²½ìš°, **ìµœì†Œ ì¢Œí‘œ(x1, y1) & ìµœëŒ€ ì¢Œí‘œ(x2, y2)**ë¡œ ë³‘í•©\n"
                            f"- ë‚´ìš©ì´ ì—†ì„ ê²½ìš° `NA`ë¡œ ë°˜í™˜, text ë‚´ìš©ì´ ì—†ëŠ” ê²½ìš° ì¢Œí‘œë¥¼ 0, 0, 0, 0ìœ¼ë¡œ í•´ì¤˜.\n"
                            f"- JSON í˜•ì‹ì´ ì •í™•í•˜ë„ë¡ ë°˜í™˜í•  ê²ƒ!\n"
                            f"- JSON í˜•ì‹ ì´ì™¸ì˜ ì–´ë–¤ ì•Œë¦¼, ë‚´ìš©ì€ ì²¨ê°€í•˜ì§€ ë§ê²ƒ!\n"
                            f"- ë°˜í™˜ ë‚´ìš© ì™¸ì˜ ê²½ê³ , ì•Œë¦¼ì€ ë°˜í™˜í•˜ì§€ ë§ê²ƒ\n"
                            f" 'ì•„ë˜ëŠ” ì œê³µëœ `xy` ë° `df` ë°ì´í„°ë¥¼ ì‚¬ìš©í•˜ì—¬ ê° í•­ëª©ì„ ë¶„ì„í•œ ê²°ê³¼ì…ë‹ˆë‹¤'ì™€ ê°™ì€ ì•Œë¦¼ì€ ì ˆëŒ€ ê¸ˆì§€\n"
                            f" OpenAI ì‘ë‹µë‚´ìš©ê¸ˆì§€\n"

                            )
                            }
                        ]
                    }
                ],
                max_tokens=1500
            )
            
            text = response.choices[0].message.content
            
            try:
                # ê²°ê³¼ ì €ì¥
                json_data = json.loads(fix_json_format(text))
                all_results[f"page{page_number}"] = json_data
                print(f"âœ… í˜ì´ì§€ {page_number} ì²˜ë¦¬ ì™„ë£Œ")
                
            except Exception as e:
                print(f"âŒ JSON ì²˜ë¦¬ ì‹¤íŒ¨ (í˜ì´ì§€ {page_number}): {e}")
                continue
                
        except Exception as e:
            print(f"âŒ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
            continue

    if all_results:
        return all_results  # ê·¸ëƒ¥ í˜ì´ì§€ë³„ ê²°ê³¼ë§Œ ë°˜í™˜
    
    return None
